$(document).ready(function(){let o=$(".login-modal");function i(e,o=null){window.optimizely=window.optimizely||[],window.optimizely.push({type:"user",attributes:{wp_user_is_logged_in:"logged_in"}}),window.optimizely.push({type:"user",attributes:{web_app__user_is_member:"1"}});if(e.cookie&&e.cookie.name&&e.cookie.value){var n=new Date,a=new Date(e.cookie.options.expires),n=(Number(Math.ceil((a.getTime()-n.getTime())/864e5)),`${e.cookie.name}=${e.cookie.value}; expires=${new Date(a).toUTCString()}; path=/; secure; httpOnly`);if(4096<(a=new Blob([n]).size))return console.error("Cookie size exceeded:",a,"bytes >",4096,"bytes limit - will cause silent browser rejection"),void l({error:"cookieSizeExceeded"},function(e){$(".login-modal .error-message").html(e),$(".login-modal").find(".loading").hide().end().find("button").show()})}var i,t,r;try{e.cookie&&e.cookie.name&&e.cookie.value&&(i=new Date,t=new Date(e.cookie.options.expires),r=Number(Math.ceil((t.getTime()-i.getTime())/864e5)),Cookies.set(e.cookie.name,e.cookie.value,{expires:r,secure:e.cookie.options.secure,httpOnly:e.cookie.options.httpOnly}),Cookies.get(e.cookie.name)||console.error("Cookie set failed - not set despite no error thrown (browser security/size restrictions)"))}catch(e){console.error("Cookie set error:",e.message)}$.fn.getLoggedInLanguagePref(e.jwt,function(e){"unknown"!==e&&$.fn.setLanguagePreference(e,!0)});n=document.location.pathname;o?(sessionStorage.removeItem("gaia_login_redirect"),window.location.replace(o)):n==="/"+GAIA_GLOBALS.lang||"job"===GAIA_GLOBALS.content_type||"article"===GAIA_GLOBALS.content_type||"hub"===GAIA_GLOBALS.content_type||"hp-24-ab-1"===GAIA_GLOBALS.post_name||"hp-24-ab-2"===GAIA_GLOBALS.post_name?window.location="/"+window.location.search:["series","person","video"].includes(GAIA_GLOBALS.content_type)?(a=new URL(GAIA_GLOBALS.wp_siteurl+"/"+GAIA_GLOBALS.content_type+"/"+GAIA_GLOBALS.post_name),GAIA_GLOBALS.page_number&&1<GAIA_GLOBALS.page_number&&("en"!==GAIA_GLOBALS.lang&&a.searchParams.append("language",GAIA_GLOBALS.lang),"series"===GAIA_GLOBALS.content_type?a.searchParams.append("season",GAIA_GLOBALS.page_number):"person"===GAIA_GLOBALS.content_type&&a.searchParams.append("page",GAIA_GLOBALS.page_number)),window.location=a.href):location.reload()}function l(a,i){$.getJSON("/wp-content/themes/gaia-marketing-layer/assets/json/login-language-pref.json",function(e){let o=a.error||(a.codes&&a.codes[0]?a.codes[0]:"default"),n=!!o&&e[GAIA_GLOBALS.lang][o];n=n||e[GAIA_GLOBALS.lang].default,i(n)}).fail(function(){console.log("Warning: Error loading language preference text config file.")})}function e(e){var o=$("input[login='login_user']"),n=$("input[login='login_pw']"),a=$("button.login-btn");""!==n.val()&&""!==o.val()?a.removeAttr("disabled"):a.attr("disabled","disabled")}$(".layer-modal .close-modal-btn").click(function(e){$.fn.closeModal(),clearInterval(w)}),$("body").on("click",".login.btn, .login.link",function(e){e.preventDefault(),$.fn.openModal(o);e=$(this).attr("data-email");(e?o.find(".username").val(e).end().find(".password"):o.find(".username")).focus()}),$(".layer-modal .login-modal").find("button.login-btn").click(function(e){e.preventDefault();let a=$(this).attr("data-redirect-to");$(".login-password input").prop("type","password"),$(this).fadeOut(200,function(e){o.find(".loading").fadeIn(200),$.ajax({method:"POST",url:GAIA_GLOBALS.dbi_brooklyn_api+"/v1/login",crossDomain:!0,contentType:"application/x-www-form-urlencoded",data:"username="+encodeURIComponent(o.find(".username").val())+"&password="+encodeURIComponent(o.find(".password").val())+"&cookie[include]=true&cookie[domain]="+encodeURIComponent(GAIA_GLOBALS.dbi_aws_domain),dataType:"json",success:function(e,o,n){1==e.success?i(e,a):(console.error("Login failed - data.success is false, error data:",e),GAIA_GLOBALS.setBackToText&&$(".login-password input").prop("type","text"),l(e,function(e){$(".login-modal .error-message").html(e),$(".login-modal").find(".loading").hide().end().find("button").show()}))},error:function(e,o,n){console.error("Login API Error:",o,"Status:",e.status,"Response:",e.responseText),$(".login-modal .error-message").text("There was a technical error. Please try again."),$(".login-modal").find(".loading").hide().end().find("button").show()}})})}),$("input[login='login_pw'] , input[login='login_user']").on("load",e()).on("keyup change blur focus input",e);var n=$("#forgot-pw-send");if($(n)&&$(n)[0]&&!$(n)[0].checkValidity())return $(n).find('input[type="submit"]').click(),!1;$(".layer-modal .forgot-password-modal").find("button").click(function(e){e.preventDefault();let a=$(".forgot-password-modal").find(".email").val();$(this).fadeOut(200,function(){$(".forgot-password-modal").find(".loading").fadeIn(200),$.ajax({method:"POST",url:GAIA_GLOBALS.dbi_brooklyn_api+"/v1/password/send-email",data:{email:a,primaryLanguage:GAIA_GLOBALS.lang},dataType:"json",success:function(e,o,n){!0===e.success?$(".layer-modal").find(".modal-inner").hide().end().find(".forgot-password-confirm-modal").find(".forgot-password__email").text(a).end().show():l(e,function(e){$(".forgot-password-modal .error-message").html(e),$(".forgot-password-modal").find(".loading").hide().end().find("button").show()})},error:function(e,o,n){console.error("ERROR!: PW Reset Error: ",o," errorThrown: ",n)}})})}),$(".layer-modal .login__forgot-password-link").click(function(e){$.fn.openModal($(".forgot-password-modal")),$(".forgot-password-modal").find(".email").focus()}),$(".layer-modal .forgot-password-confirm-modal").find("button").click(function(e){$(".layer-modal").find(".forgot-password-modal").find(".password").val(""),$.fn.closeModal()});let t=5e3,r=120,d=t*r,s=$(".layer-modal .login-with-code-modal"),c=s.find(".login-with-code-modal__submit"),f=s.find("input[name='email']"),u=$(".layer-modal .login-verify-code-modal"),g=u.find(".login-verify-code-modal__code-input"),p=u.find(".login-verify-code-modal__expired"),m=!1,_=0,h=null,w=null;function A(e){$.ajax({method:"POST",url:GAIA_GLOBALS.dbi_brooklyn_api+"/v1/request-magic-link?language[]="+GAIA_GLOBALS.lang,contentType:"application/json",data:JSON.stringify({email:e}),dataType:"json",success:function(a){a.remoteLoginCode?(u.find(".login-verify-code-modal__email").text(e),$.fn.openModal(u),m=new Date>new Date(a.expiresAt),_=0,h=null,m||(w=setInterval(function(){var e,o,n;e=a.remoteLoginCode,o=_>=r,n=!!h&&Date.now()-h>=d,m||o||n?(g.attr("disabled","disabled"),clearInterval(w),p.fadeIn(200)):(h=h||Date.now(),_+=1,v(e,!0))},t))):(s.find(".loading").hide(),c.fadeIn(200),s.find(".login-with-code-modal__unknown-error").fadeIn(200))},error:function(e,o){console.error("Request Magic Link API Error: ",e," errorThrown: ",o),s.find(".loading").hide(),c.fadeIn(200),s.find(".login-with-code-modal__unknown-error").fadeIn(200)}})}function a(){g.removeAttr("disabled"),p.hide(),g.val("")}function v(e,n=!1){$.ajax({method:"GET",url:GAIA_GLOBALS.dbi_brooklyn_api+"/v1/consume-code/"+e,success:function(e){"approved"===e.status&&e.jwt?(u.find(".error-message").fadeOut(200),clearInterval(w),w=null,e=e.jwt,$.ajax({method:"POST",url:GAIA_GLOBALS.dbi_brooklyn_api+"/v1/renew",contentType:"application/x-www-form-urlencoded",headers:{Authorization:"Bearer "+e},data:{cookie:{include:!0,domain:GAIA_GLOBALS.dbi_aws_domain}},success:function(e){e.success?(g.attr("disabled","disabled"),u.find(".error-message").fadeOut(200),u.find(".loading").fadeIn(200),i(e,window.location.href)):(console.error("Renew auth failed - data.success is false"),u.find(".login-verify-code-modal__unknown-error").fadeIn(200))},error:function(e,o,n){console.error("Renew Auth API Error:",o,"Status:",e.status,"Response:",e.responseText),u.find(".login-verify-code-modal__unknown-error").fadeIn(200)}})):n||u.find(".login-verify-code-modal__error").fadeIn(200)},error:function(e,o){n||(console.error("Consume Code API Error: ",e," errorThrown: ",o),u.find(".login-verify-code-modal__error").fadeIn(200))}})}function y(){u.find(".error-message").fadeOut(200);var e=g.map(function(){return $(this).val()}).get().join("");e.length===g.length&&v(e)}f.on("input keyup change blur",function(){s.find(".error-message").fadeOut(200),""!==f.val()&&f[0].checkValidity()?c.removeAttr("disabled"):c.attr("disabled","disabled")}),c.on("click",function(e){e.preventDefault();let a=f.val();c.fadeOut(200,function(){var e,o,n;s.find(".loading").fadeIn(200),e=a,o=function(e){e?A(a):(s.find(".loading").hide(),c.fadeIn(200),s.find(".login-with-code-modal__error").fadeIn(200))},n=function(){s.find(".loading").hide(),c.fadeIn(200),s.find(".login-with-code-modal__unknown-error").fadeIn(200)},$.ajax({method:"POST",url:GAIA_GLOBALS.dbi_brooklyn_api+"/v1/checkout/account-check",contentType:"application/json",data:JSON.stringify({email:e}),dataType:"json",success:function(e){o(!1===e.available)},error:function(e,o){console.error("Account Check API Data Error: ",e," errorThrown: ",o),n()}})})}),p.on("click",function(){_=0,h=null,m=!1;var e=f.val();e?(A(e),a()):u.find(".login-verify-code-modal__unknown-error").fadeIn(200)}),g.on("input",function(){var e=$(this).val();/^\d$/.test(e)||$(this).val("")}).on("input",function(){var e=g.index(this);""!==$(this).val()&&e<g.length-1&&g.eq(e+1).focus().trigger("change"),e===g.length-1&&y()}).on("keydown",function(e){var o=g.index(this);"Backspace"===e.key&&""===$(this).val()&&0<o&&g.eq(o-1).focus().trigger("change")}).on("paste",function(e){e.preventDefault();var o=(e.originalEvent||e).clipboardData.getData("text").replace(/\D/g,"");for(let e=0;e<o.length&&e<g.length;e++)g.eq(e).val(o.charAt(e));e=Math.min(o.length-1,g.length-1),g.eq(e).focus().trigger("change")}).on("change",y),$(".layer-modal").on("click",".login-modal__code-btn, .login-verify-code-modal__send-again",function(e){e.preventDefault(),clearInterval(w),a(),s.find(".loading").hide(),c.show(),s.find(".login-with-code-modal__password-btn").show(),$.fn.openModal(s),f.focus()}).on("click",".login-with-code-modal__password-btn, .login-verify-code-modal__sign-up",function(e){e.preventDefault(),clearInterval(w),$.fn.openModal($(".login-modal")),$(".login-modal").find(".username").focus()}),$(".layer-modal .language-selection-modal").find("button").click(function(e){$.fn.openModal($(this),!1)}),$(".language-selection-modal.modal-inner a").click(function(e){e.preventDefault(),$(".layer-modal .language-selection-modal").find("button").attr("disabled",!1).end().find("button").removeClass("btn--disabled"),e=$(this),$(".language-selection-modal .selector__modal--option, .language-selection-modal .circle ").removeClass("highlight"),$(e).find(".circle").addClass("highlight").end().closest(".selector__modal--option").addClass("highlight")}),$(".language-selection-modal.modal-inner button.btn").click(function(e){e.preventDefault();e=$(".language-selection-modal.modal-inner .selector__modal--option.highlight a");$.fn.setLanguagePreference($(e).attr("data-lang"),!0),$.fn.preserveQueryString(window.location.pathname)!==$.fn.preserveQueryString($(e).attr("href"))?($.fn.closeModal(),window.open($.fn.preserveQueryString($(e).attr("href")),"_self")):$.fn.closeModal()})});